{% extends "base.html" %}

{% block title %}Register - Hospital Management System{% endblock %}

{% block content %}
<div id="app" class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4">
                        <i class="bi bi-person-plus-fill text-primary"></i>
                        <br>Patient Registration
                    </h2>
                    
                    <!-- Alert Messages -->
                    <div v-if="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <span v-text="errorMessage"></span>
                        <button type="button" class="btn-close" @click="errorMessage = ''"></button>
                    </div>
                    
                    <div v-if="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle"></i> <span v-text="successMessage"></span>
                        <button type="button" class="btn-close" @click="successMessage = ''"></button>
                    </div>

                    <!-- Registration Form -->
                    <form @submit.prevent="handleRegister">
                        <!-- Account Information -->
                        <h5 class="mb-3"><i class="bi bi-shield-lock"></i> Account Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">Username *</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="username" 
                                    v-model="registerForm.username" 
                                    required
                                >
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input 
                                    type="email" 
                                    class="form-control" 
                                    id="email" 
                                    v-model="registerForm.email" 
                                    required
                                >
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Password *</label>
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="password" 
                                    v-model="registerForm.password" 
                                    required
                                    minlength="6"
                                >
                                <small class="text-muted">Minimum 6 characters</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password *</label>
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="confirmPassword" 
                                    v-model="confirmPassword" 
                                    required
                                >
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Personal Information -->
                        <h5 class="mb-3"><i class="bi bi-person"></i> Personal Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="full_name" class="form-label">Full Name *</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="full_name" 
                                    v-model="registerForm.full_name" 
                                    required
                                >
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone *</label>
                                <input 
                                    type="tel" 
                                    class="form-control" 
                                    id="phone" 
                                    v-model="registerForm.phone" 
                                    required
                                    pattern="[0-9]{10}"
                                >
                                <small class="text-muted">10-digit number</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea 
                                class="form-control" 
                                id="address" 
                                v-model="registerForm.address" 
                                rows="2"
                            ></textarea>
                        </div>

                        <hr class="my-4">

                        <!-- Medical Information -->
                        <h5 class="mb-3"><i class="bi bi-clipboard2-pulse"></i> Medical Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="date_of_birth" 
                                    v-model="registerForm.date_of_birth"
                                >
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="blood_group" class="form-label">Blood Group</label>
                                <select class="form-select" id="blood_group" v-model="registerForm.blood_group">
                                    <option value="">Select...</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="emergency_contact" class="form-label">Emergency Contact</label>
                            <input 
                                type="tel" 
                                class="form-control" 
                                id="emergency_contact" 
                                v-model="registerForm.emergency_contact"
                            >
                        </div>

                        <div class="mb-3">
                            <label for="medical_history" class="form-label">Medical History</label>
                            <textarea 
                                class="form-control" 
                                id="medical_history" 
                                v-model="registerForm.medical_history" 
                                rows="2"
                                placeholder="Any chronic diseases, past surgeries, etc."
                            ></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="allergies" class="form-label">Allergies</label>
                            <textarea 
                                class="form-control" 
                                id="allergies" 
                                v-model="registerForm.allergies" 
                                rows="2"
                                placeholder="Drug allergies, food allergies, etc."
                            ></textarea>
                        </div>

                        <button 
                            type="submit" 
                            class="btn btn-primary w-100 mt-3"
                            :disabled="loading"
                        >
                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                            <span v-text="loading ? 'Registering...' : 'Register'"></span>
                        </button>

                        <div class="text-center mt-3">
                            <p class="mb-0">Already have an account? 
                                <a href="/" class="text-primary">Login here</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            registerForm: {
                username: '',
                email: '',
                password: '',
                full_name: '',
                phone: '',
                address: '',
                date_of_birth: '',
                blood_group: '',
                emergency_contact: '',
                medical_history: '',
                allergies: ''
            },
            confirmPassword: '',
            loading: false,
            errorMessage: '',
            successMessage: ''
        }
    },
    methods: {
        async handleRegister() {
            // Validate passwords match
            if (this.registerForm.password !== this.confirmPassword) {
                this.errorMessage = 'Passwords do not match';
                return;
            }

            this.loading = true;
            this.errorMessage = '';
            
            try {
                const response = await axios.post('/api/auth/register', this.registerForm);
                
                if (response.data.message) {
                    this.successMessage = 'Registration successful! Redirecting to login...';
                    
                    // Redirect to login after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } catch (error) {
                if (error.response && error.response.data) {
                    this.errorMessage = error.response.data.error || 'Registration failed';
                } else {
                    this.errorMessage = 'Network error. Please try again.';
                }
            } finally {
                this.loading = false;
            }
        }
    }
}).mount('#app');
</script>
{% endblock %}